name: CI

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]

permissions:
  contents: read
  deployments: write

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Build & Quality Checks
  # ============================================
  quality:
    name: Build & Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate types (codegen)
        run: npm run codegen

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run typecheck
        continue-on-error: true  # TODO: Fix existing type errors and remove this

      - name: Build
        run: npm run build
        env:
          # Provide minimal env vars for build to succeed
          SESSION_SECRET: ci-build-secret
          PUBLIC_STORE_DOMAIN: ${{ vars.PUBLIC_STORE_DOMAIN || 'example.myshopify.com' }}

  # ============================================
  # Unit Tests
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate types (codegen)
        run: npm run codegen

      - name: Run unit tests
        run: npm run test -- --reporter=verbose
        continue-on-error: true  # TODO: Fix failing tests and remove this

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ============================================
  # Deploy to Oxygen
  # ============================================
  deploy:
    name: Deploy to Oxygen
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [quality, unit-tests]
    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment-url }}
      environment: ${{ steps.deploy.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Oxygen
        id: deploy
        run: |
          # Run deploy and capture output
          OUTPUT=$(npx shopify hydrogen deploy --json-output 2>&1) || true
          echo "$OUTPUT"
          
          # Extract deployment URL from output
          DEPLOY_URL=$(echo "$OUTPUT" | grep -oP 'https://[a-zA-Z0-9-]+\.oxygen\.myshopify\.com' | head -1 || true)
          
          # If no URL found in output, construct from branch
          if [ -z "$DEPLOY_URL" ]; then
            BRANCH_NAME="${GITHUB_REF_NAME}"
            if [ "$BRANCH_NAME" = "main" ]; then
              DEPLOY_URL="https://www.vapourism.co.uk"
              ENVIRONMENT="production"
            else
              # Preview URL pattern for Oxygen
              DEPLOY_URL="https://${GITHUB_SHA:0:7}--vapourismv2.oxygen.myshopify.com"
              ENVIRONMENT="preview"
            fi
          else
            if [ "$GITHUB_REF_NAME" = "main" ]; then
              ENVIRONMENT="production"
            else
              ENVIRONMENT="preview"
            fi
          fi
          
          echo "deployment-url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOY_URL ($ENVIRONMENT)"
        env:
          SHOPIFY_HYDROGEN_DEPLOYMENT_TOKEN: ${{ secrets.OXYGEN_DEPLOYMENT_TOKEN_1000063397 }}

  # ============================================
  # E2E Tests (Preview only - not on main)
  # ============================================
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: deploy
    # Only run on non-main branches (preview deployments)
    if: github.ref_name != 'main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Wait for deployment to be ready
        run: |
          DEPLOY_URL="${{ needs.deploy.outputs.deployment-url }}"
          echo "Waiting for deployment at $DEPLOY_URL to be ready..."
          
          # Wait up to 5 minutes for deployment to be accessible
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Try to access the deployment with preview password header if set
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "X-Shopify-Oxygen-Preview-Password: ${{ secrets.OXYGEN_PREVIEW_PASSWORD }}" \
              --max-time 10 \
              "$DEPLOY_URL" 2>/dev/null || echo "000")
            
            echo "HTTP status: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "Deployment is ready!"
              exit 0
            fi
            
            sleep 10
          done
          
          echo "Deployment not ready after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Run Playwright tests
        run: npx playwright test --reporter=html
        env:
          PLAYWRIGHT_BASE_URL: ${{ needs.deploy.outputs.deployment-url }}
          BASE_URL: ${{ needs.deploy.outputs.deployment-url }}
          # Oxygen preview password for authenticated access
          OXYGEN_PREVIEW_PASSWORD: ${{ secrets.OXYGEN_PREVIEW_PASSWORD }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 7
